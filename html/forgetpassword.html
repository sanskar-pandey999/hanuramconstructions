<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Georget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        /* Custom font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Optional: Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }

        /* Basic form group styling for showing/hiding */
        .form-group {
            display: none;
        }
        .form-group.active {
            display: block;
        }

        /* Message styling */
        .message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        .message.info {
            background-color: #e0f2fe; /* light blue */
            color: #0284c7; /* blue-600 */
            border: 1px solid #7dd3fc; /* sky-300 */
        }
        .message.success {
            background-color: #dcfce7; /* green-100 */
            color: #16a34a; /* green-600 */
            border: 1px solid #86efac; /* green-300 */
        }
        .message.error {
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
            border: 1px solid #fca5a5; /* red-300 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <div class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">

        <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8 lg:p-10 max-w-lg w-full text-center">

            <header class="mb-8">
                <h1 id="formTitle" class="text-3xl sm:text-4xl font-extrabold text-blue-700 mb-4 tracking-tight">
                    Forgot Your Password?
                </h1>
                <p class="text-md sm:text-lg text-gray-600 leading-relaxed">
                    Don't worry, we can help you reset it.
                </p>
            </header>

            <form id="forgotPasswordEmailForm" class="form-group active" action="#" method="POST">
                <div class="input-grp mb-6">
                    <div class="relative flex items-center mb-4">
                        <i class="fa-solid fa-envelope absolute left-3 text-gray-400"></i>
                        <input type="email" placeholder="Enter your email" name="email" id="forgotEmail" required
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                    </div>
                    <p class="message" id="emailMessage"></p>
                    <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Send Verification Email
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    <a href="/html/login.html" id="backToLoginLink" class="text-blue-600 hover:underline">Back to Login</a>
                </p>
            </form>

            <form id="verifyPinForm" class="form-group" action="#" method="POST">
                <div class="input-grp mb-6">
                    <div class="relative flex items-center mb-4">
                        <i class="fa-solid fa-lock absolute left-3 text-gray-400"></i>
                        <input type="text" placeholder="Enter verification PIN" name="pin" id="verifyPin" required
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                    </div>
                    <p class="message" id="pinMessage"></p>
                    <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Verify PIN
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    <a href="#" id="resendPinLink" class="text-blue-600 hover:underline mr-4">Resend PIN</a>
                    <a href="/html/login.html" id="backToLoginFromPinLink" class="text-blue-600 hover:underline">Back to Login</a>
                </p>
            </form>

            <form id="setNewPinForm" class="form-group" action="#" method="POST">
                <div class="input-grp mb-6">
                    <div class="relative flex items-center mb-4">
                        <i class="fa-solid fa-key absolute left-3 text-gray-400"></i>
                        <input type="password" placeholder="Enter new password" name="newPassword" id="newPassword" required
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                    </div>
                    <div class="relative flex items-center mb-4">
                        <i class="fa-solid fa-key absolute left-3 text-gray-400"></i>
                        <input type="password" placeholder="Confirm new password" name="confirmNewPassword" id="confirmNewPassword" required
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                    </div>
                    <p class="message" id="newPasswordMessage"></p> <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Set New Password
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    <a href="/html/login.html" id="backToLoginFromNewPinLink" class="text-blue-600 hover:underline">Back to Login</a>
                </p>
            </form>

        </div>

        <footer class="mt-8 text-gray-500 text-sm">
            &copy; Hanuram Constructions. All rights reserved.
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formTitle = document.getElementById('formTitle');
            const forgotPasswordEmailForm = document.getElementById('forgotPasswordEmailForm');
            const verifyPinForm = document.getElementById('verifyPinForm');
            const setNewPinForm = document.getElementById('setNewPinForm');

            // Input fields
            const forgotEmailInput = document.getElementById('forgotEmail');
            const verifyPinInput = document.getElementById('verifyPin');
            const newPasswordInput = document.getElementById('newPassword'); // Renamed from newPin
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword'); // Renamed from confirmNewPin


            // Links
            const backToLoginLink = document.getElementById('backToLoginLink');
            const backToLoginFromPinLink = document.getElementById('backToLoginFromPinLink');
            const backToLoginFromNewPinLink = document.getElementById('backToLoginFromNewPinLink');
            const resendPinLink = document.getElementById('resendPinLink');

            // Message display elements
            const emailMessage = document.getElementById('emailMessage');
            const pinMessage = document.getElementById('pinMessage');
            const newPasswordMessage = document.getElementById('newPasswordMessage'); // Renamed from newPinMessage

            // Variable to store the email across steps
            let currentEmail = '';

            // Helper function to show a form and hide others
            function showForm(formToShow, newTitle) {
                [forgotPasswordEmailForm, verifyPinForm, setNewPinForm].forEach(form => {
                    form.classList.remove('active');
                });
                formToShow.classList.add('active');
                formTitle.textContent = newTitle;
                clearMessages(); // Clear messages when switching forms
            }

            function showMessage(element, message, type) {
                element.textContent = message;
                element.className = `message ${type}`;
                element.style.display = 'block';
            }

            function clearMessages() {
                emailMessage.textContent = '';
                emailMessage.className = 'message';
                emailMessage.style.display = 'none';

                pinMessage.textContent = '';
                pinMessage.className = 'message';
                pinMessage.style.display = 'none';

                newPasswordMessage.textContent = '';
                newPasswordMessage.className = 'message';
                newPasswordMessage.style.display = 'none';
            }

            // --- Event Listeners ---

            // Forgot Password Email Form Submission
            forgotPasswordEmailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = forgotEmailInput.value.trim(); // Trim whitespace
                currentEmail = email; // Store email for subsequent steps

                showMessage(emailMessage, 'Sending verification email...', 'info');

                try {
                    const response = await fetch('/api/forgot-password/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: currentEmail })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage(emailMessage, data.message, 'success');
                        setTimeout(() => showForm(verifyPinForm, 'Verify Your PIN'), 2000);
                    } else {
                        showMessage(emailMessage, data.message || 'Error sending email. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Error sending email request:', error);
                    showMessage(emailMessage, 'Network error. Please try again later.', 'error');
                }
            });

            // Verify PIN Form Submission
            verifyPinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pin = verifyPinInput.value.trim();

                showMessage(pinMessage, 'Verifying PIN...', 'info');

                try {
                    const response = await fetch('/api/forgot-password/verify-pin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: currentEmail, pin: pin })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage(pinMessage, data.message, 'success');
                        setTimeout(() => showForm(setNewPinForm, 'Set New Password'), 2000);
                    } else {
                        showMessage(pinMessage, data.message || 'Invalid PIN. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Error verifying PIN request:', error);
                    showMessage(pinMessage, 'Network error. Please try again later.', 'error');
                }
            });

            // Set New Password Form Submission
            setNewPinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = newPasswordInput.value;
                const confirmNewPassword = confirmNewPasswordInput.value;

                if (newPassword !== confirmNewPassword) {
                    showMessage(newPasswordMessage, 'Passwords do not match.', 'error');
                    return;
                }

                if (newPassword.length < 6) { // Basic password length validation
                    showMessage(newPasswordMessage, 'Password must be at least 6 characters long.', 'error');
                    return;
                }


                showMessage(newPasswordMessage, 'Setting new password...', 'info');

                try {
                    const response = await fetch('/api/forgot-password/set-new-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // Ensure 'newPin' matches the backend's expected property name
                        body: JSON.stringify({ email: currentEmail, newPin: newPassword })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage(newPasswordMessage, data.message, 'success');
                        // Redirect to login page after successful password reset
                        setTimeout(() => window.location.href = '/html/login.html', 3000);
                    } else {
                        showMessage(newPasswordMessage, data.message || 'Error setting new password. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Error setting new password request:', error);
                    showMessage(newPasswordMessage, 'Network error. Please try again later.', 'error');
                }
            });

            // Resend PIN Link
            resendPinLink.addEventListener('click', async (e) => {
                e.preventDefault();
                showMessage(pinMessage, 'Resending PIN...', 'info');

                try {
                    const response = await fetch('/api/forgot-password/resend-pin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: currentEmail })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage(pinMessage, data.message, 'success');
                    } else {
                        showMessage(pinMessage, data.message || 'Error resending PIN. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Error resending PIN request:', error);
                    showMessage(pinMessage, 'Network error. Please try again later.', 'error');
                }
            });

            // Back to Login Links
            [backToLoginLink, backToLoginFromPinLink, backToLoginFromNewPinLink].forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = '/html/login.html'; // Direct redirect to login page
                });
            });

            // Initial state: show the email input form
            showForm(forgotPasswordEmailForm, 'Forgot Your Password?');
        });
    </script>
</body>
</html>